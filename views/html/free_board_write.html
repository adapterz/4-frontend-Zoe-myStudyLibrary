<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>myStudyLibrary ììœ ê²Œì‹œíŒ</title>
    <style>
      @import url("/views/css/reset.css");
      @import url("/views/css/common.css");
      @import url("/views/css/free_board.css");
      @import url("/views/css/free_board_write.css");
      /* ê¸€ì”¨ì²´ */
      @import url("https://fonts.googleapis.com/css2?family=Grape+Nuts&family=Gugi&family=Lobster&family=Noto+Sans+KR:wght@300&family=Noto+Serif+KR&family=Poor+Story&display=swap");
    </style>
  </head>
  <body>
    <!-- gmb -->
    <header>
      <script src="/views/js/header.js"></script>
    </header>
    <article class="freeBoard">
      <p class="freeBoard__title">ğŸ“‹ ììœ ê²Œì‹œíŒ - ê¸€ì‘ì„±</p>
      <form
        action=""
        class="container__write"
        method="post"
        onsubmit="writePost(document.getElementsByName('postTitle')[0].value,document.getElementsByName('postContent')[0].value,document.getElementsByName('tags')[0].value);return false"
      >
        <input
          type="text"
          placeholder="ê¸€ ì œëª©"
          class="container__write--title"
          name="postTitle"
          required
          minlength="2"
          maxlength="50"
          oninput="checkTitleLength(this)"
        />
        <span class="container__title--length">(0/50)</span>
        <textarea
          placeholder="ê¸€ ë‚´ìš©"
          class="container__write--content"
          name="postContent"
          required
          minlength="2"
          maxlength="5000"
          oninput="checkContentLength(this)"
        ></textarea>
        <span class="container__content--length">(0/5000)</span>
        <input
          type="text"
          placeholder="#íƒœê·¸(ìµœëŒ€ 5ê°œ) ì•„ë˜ ?ì— ì»¤ì„œë¥¼ ì˜¬ë ¤ì„œ íƒœê·¸ ì‘ì„±ë²•ì„ í™•ì¸í•´ì£¼ì„¸ìš”"
          class="container__write--tag"
          name="tags"
          oninput="checkTagValidation(this)"
        />
        <nav class="container__tag--tooltip">
          <li>â”</li>
          <li class="container__tag--tooltipText">
            <p>
              #ì„ êµ¬ë¶„ìë¡œ íƒœê·¸ ì‘ì„±<br />2~8ê¸€ì ì‚¬ì´ í•œê¸€ë§Œ(ã„±,ã… ë“±ìœ¼ë¡œ ë‚˜ëˆ ì“°ëŠ” ê²ƒ ë¶ˆê°€ 'ê°€' ì²˜ëŸ¼ ì™„ë²½í•œ í•œ ê¸€ìë§Œ
              ì‚¬ìš© ê°€ëŠ¥)<br />ë„ì–´ì“°ê¸°ë¶ˆê°€<br />ex)#ë„ì–´ì“°ê¸°ë¶ˆê°€#ë‹¤ì„¯ê°œê¹Œì§€#ë‘ê¸€ìì—ì„œì—¬ëŸ#í•œê¸€ë§Œ
            </p>
          </li>
        </nav>
        <input type="submit" value="í™•ì¸" class="container__search--submit" />
      </form>
    </article>

    <!-- footer -->
    <footer class="footer__serviceInfo">
      <script src="/views/js/footer.js"></script>
    </footer>

    <!-- sweetAlert2 -->
    <script src="/views/js/sweetalert2.js" type="text/javascript"></script>
    <script src="/views/js/custom.js" type="text/javascript"></script>
    <!--fetch-->
    <script src="/customs/constant.js" type="text/javascript"></script>
    <script src="/models/board.js" type="text/javascript"></script>
    <script>
      // ì œëª© ê¸€ììˆ˜ ì²´í¬
      async function checkTitleLength(titleElement) {
        const length = titleElement.value.length;
        document.getElementsByClassName("container__title--length")[0].innerHTML = `(${length}/50)`;
        if (length > 50) {
          const substring = titleElement.value.substring(0, 49);
          console.log(substring);
          titleElement.value = substring;
          const length = titleElement.value.length;
          document.getElementsByClassName("container__title--length")[0].innerHTML = `(${length}/50)`;
          await sweetAlert(WARNING, "ê¸€ììˆ˜ ì´ˆê³¼", "ì œëª©ì€ 50ì ê¹Œì§€ë§Œ ì…ë ¥ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
      }
      // ë‚´ìš© ê¸€ììˆ˜ ì²´í¬
      async function checkContentLength(contentElement) {
        const length = contentElement.value.length;
        document.getElementsByClassName("container__content--length")[0].innerHTML = `(${length}/5000)`;
        if (length >= 5000) {
          const substring = contentElement.value.substring(0, 4998);
          contentElement.value = substring;
          const length = contentElement.value.length;
          document.getElementsByClassName("container__content--length")[0].innerHTML = `(${length}/5000)`;
          await sweetAlert(WARNING, "ê¸€ììˆ˜ ì´ˆê³¼", "ë‚´ìš©ì€ 5000ì ê¹Œì§€ë§Œ ì…ë ¥ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
      }
      // íƒœê·¸ ì²´í¬
      async function checkTagValidation(tagElement) {
        let isValidated = true;
        const tagArray = tagElement.value.split("#");
        tagArray.shift();
        // ìœ íš¨ì„± ì²´í¬
        // ì²« ê¸€ì #ìœ¼ë¡œ ì‹œì‘í•˜ëŠ”ì§€
        if (tagElement.value.substring(0, 1) !== "#") {
          tagElement.setCustomValidity("ì²«ê¸€ìëŠ” #ìœ¼ë¡œ ì‹œì‘í•´ì£¼ì„¸ìš”.");
          isValidated = false;
        }
        // íƒœê·¸ ë°°ì—´ë§Œë“¤ì—ˆì„ ë•Œ íƒœê·¸ ë°°ì—´ ê°œìˆ˜ê°€ 5ê°œê°€ ë„˜ëŠ”ì§€
        else if (tagArray.length > 5) {
          tagElement.setCustomValidity(`íƒœê·¸ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ì…ë‹ˆë‹¤. í˜„ì¬ íƒœê·¸ ê°œìˆ˜: ${tagArray.length}`);
          isValidated = false;
        }
        // 2~8ê¸€ì ì‚¬ì´ í•œêµ­ì–´ë¡œë§Œ ì´ë£¨ì–´ì ¸ìˆëŠ”ì§€
        else {
          for (let tag of tagArray) {
            if (tag.length < 2 || tag.length > 8) {
              tagElement.setCustomValidity("í•˜ë‚˜ëŠ” íƒœê·¸ëŠ” 2~8 ê¸€ì ì‚¬ì´ì…ë‹ˆë‹¤.");
              isValidated = false;
            } else {
              const isMatched = /^[ê°€-í£]+$/.test(tag);
              console.log(isMatched);
              if (!isMatched) {
                tagElement.setCustomValidity("íƒœê·¸ëŠ” í•œê¸€ë¡œë§Œ ì‘ì„±í•´ì£¼ì„¸ìš”(+ ê°€(o)ã„±(x))");
                isValidated = false;
              }
            }
          }
        }
        if (isValidated) {
          tagElement.setCustomValidity("");
        }
        tagElement.reportValidity();
      }
      // ê¸€ ì‘ì„± ë²„íŠ¼ í´ë¦­ì‹œ
      async function writePost(postTitle, postContent, tag) {
        const backendResult = await writePostRequest(postTitle, postContent, tag);
        // ë¡œê·¸ì¸ í•„ìš”(ì‹œê°„ì´ ì§€ë‚˜ ë¡œê·¸ì•„ì›ƒ ëì„ ê²½ìš°)
        if (backendResult.state === LOGIN_REQUIRED) {
          const result = await sweetAlert(WARNING, "ë¡œê·¸ì¸ í•„ìš”", "ìƒˆ ì°½ì—ì„œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”");
          window.open("/user/login");
        }

        // ê¸€ ì‘ì„± ì„±ê³µ
        if (backendResult.state === REQUEST_SUCCESS) {
          const result = await sweetAlert(SUCCESS, "ê¸€ ì‘ì„± ì„±ê³µ", "ê¸€ ëª©ë¡ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
          if (result) {
            const link = "/board";
            location.href = link;
          }
        }
        // ê·¸ ì™¸ì˜ ì—ëŸ¬
        if (backendResult.state !== LOGIN_REQUIRED && backendResult.state !== REQUEST_SUCCESS) {
          const result = await sweetAlert(
            ERROR,
            "ê¸€ ì‘ì„± ì‹¤íŒ¨",
            "ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ì…ë‹ˆë‹¤.",
            `ì„œë²„ ë©”ì‹œì§€: ${backendResult.state}`
          );
        }
      }
    </script>
  </body>
</html>
